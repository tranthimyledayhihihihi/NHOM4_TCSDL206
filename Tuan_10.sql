USE master
IF  EXISTS (SELECT name FROM sys.databases WHERE name = 'TUAN_19')
BEGIN
    ALTER DATABASE TUAN_19 SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
	DROP DATABASE TUAN_19;
END
CREATE DATABASE TUAN_19;
GO
USE TUAN_19;
GO
--BẢNG KHACHHANG
CREATE TABLE KHACHHANG (
    MAKHACHHANG CHAR(10) PRIMARY KEY,
    TENCONGTY NVARCHAR(100) NOT NULL,
    TENGIAODICH NVARCHAR(100) NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    EMAIL VARCHAR(50)  UNIQUE,
    DIENTHOAI VARCHAR(10) UNIQUE,
    FAX NVARCHAR(25)
);
--BẢNG NHANVIEN
CREATE TABLE NHANVIEN (
    MANHANVIEN CHAR(10) PRIMARY KEY,
    TEN NVARCHAR(20) NOT NULL,
    HO NVARCHAR(20) NOT NULL,
    NGAYSINH DATE NOT NULL,
    NGAYLAMVIEC DATE NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    DIENTHOAI VARCHAR(10) UNIQUE,
    LUONGCOBAN DECIMAL(15, 2) NOT NULL,
    PHUCAP DECIMAL(10, 2)
);
--BẢNG NHACUNGCAP
CREATE TABLE NHACUNGCAP (
    MACONGTY CHAR(10) PRIMARY KEY,
    TENCONGTY NVARCHAR(100) NOT NULL,
    TENGIAODICH NVARCHAR(50) NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    DIENTHOAI VARCHAR(10) UNIQUE,
    FAX NVARCHAR(25),
    EMAIL VARCHAR(50) UNIQUE
);
--BẢNG LOAIHANG
CREATE TABLE LOAIHANG (
    MALOAIHANG CHAR(10) PRIMARY KEY,
    TENLOAIHANG NVARCHAR(40) NOT NULL
);
--BẢNG MATHANG
CREATE TABLE MATHANG (
    MAHANG CHAR(10) PRIMARY KEY,
    TENHANG NVARCHAR(100) NOT NULL,
    MALOAIHANG CHAR(10) NOT NULL,
    MACONGTY CHAR(10) NOT NULL,
    SOLUONG FLOAT NOT NULL,
    DVTINH NVARCHAR(20) NOT NULL,
    GIAHANG MONEY NOT NULL,
    FOREIGN KEY (MALOAIHANG) REFERENCES LOAIHANG(MALOAIHANG)
		ON DELETE
			CASCADE
		ON UPDATE
			CASCADE,
    FOREIGN KEY (MACONGTY) REFERENCES NHACUNGCAP(MACONGTY)
		ON DELETE
			CASCADE
		ON UPDATE
			CASCADE
);
--BẢNG DONDATHANG
CREATE TABLE DONDATHANG (
    SOHOADON CHAR(10) PRIMARY KEY,
    MAKHACHHANG CHAR(10) NOT NULL,
    MANHANVIEN CHAR(10) NOT NULL,
    NGAYDATHANG DATE NOT NULL,
    NGAYGIAOHANG DATE,
    NGAYCHUYENHANG DATE,
    NOIGIAOHANG NVARCHAR(100),
    FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG)
		ON DELETE
			CASCADE
		ON UPDATE
			CASCADE,
    FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)
		ON DELETE
			CASCADE
		ON UPDATE
			CASCADE
);
--BẢNG CHITIETDATHANG
CREATE TABLE CHITIETDATHANG (
    SOHOADON CHAR(10) NOT NULL,
    MAHANG CHAR(10) NOT NULL,
    GIABAN MONEY NOT NULL,
    SOLUONG FLOAT NOT NULL,
    MUCGIAMGIA MONEY,
	PRIMARY KEY(SOHOADON,MAHANG),
    FOREIGN KEY (SOHOADON) REFERENCES DONDATHANG(SOHOADON)
		ON DELETE
			CASCADE
		ON UPDATE
			CASCADE,
    FOREIGN KEY (MAHANG) REFERENCES MATHANG(MAHANG)
		ON DELETE
			CASCADE
		ON UPDATE
			CASCADE
);
--SOLUONG MẶC ĐỊNH LÀ 1, MUCGIAMGIA MẶC ĐỊNH LÀ 0
ALTER TABLE CHITIETDATHANG 
	ADD CONSTRAINT DF_SOLUONG DEFAULT 1 FOR SOLUONG,
		CONSTRAINT DF_MUCGIAMGIA DEFAULT 0 FOR MUCGIAMGIA;
--RÀNG BUỘC NGAYGIAOHANG,NGAYDATHANG,NGAYCHUYENHANG
ALTER TABLE DONDATHANG
	ADD CONSTRAINT CK_NGAYGIAOHANG
	CHECK (NGAYGIAOHANG >= NGAYDATHANG),
	CONSTRAINT CK_NGAYCHUYENHANG
	CHECK (NGAYCHUYENHANG >= NGAYDATHANG);
-- NHÂN VIÊN TỪ 18N ĐẾN 60 TUỔI
ALTER TABLE NHANVIEN
	ADD CONSTRAINT CK_TUOI_NHANVIEN 
	CHECK (DATEDIFF(YEAR, NGAYSINH, GETDATE()) >= 18 AND DATEDIFF(YEAR, NGAYSINH, GETDATE()) <= 60);
--RÀNG BUỘC EMAIL
ALTER TABLE KHACHHANG
    ADD CONSTRAINT CK_KhachHang_Email
    CHECK (EMAIL LIKE '%@%.%');

ALTER TABLE NhaCungCap
	ADD CONSTRAINT CK_NhaCungCap_Email
		CHECK (Email LIKE '[a-z][A-Z]%@%_')
--DIENTHOAI PHẢI LÀ SỐ TỪ 0 ĐẾN 9
ALTER TABLE KhachHang
	ADD CONSTRAINT CK_KhachHang_SDT
		CHECK (DIENTHOAI LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
ALTER TABLE NhanVien
	ADD CONSTRAINT CK_NhanVien_SDT
		CHECK (DIENTHOAI LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
ALTER TABLE NhaCungCap
	ADD CONSTRAINT CK_NhaCungCap_SDT
		CHECK (DIENTHOAI LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
--MẶC ĐỊNH LUONGCOBAN LÀ 5000000 VÀ LUONGCOBAN >0
ALTER TABLE NhanVien
	ADD CONSTRAINT CK_NhanVien_LUONGCOBAN
		DEFAULT '5000000' FOR LUONGCOBAN,
		CHECK(LUONGCOBAN>0)
SET DATEFORMAT dmy;
-- Thêm dữ liệu vào bảng LOAIHANG
INSERT INTO LOAIHANG (MALOAIHANG, TENLOAIHANG) 
VALUES ('LH00000001', N'Đồ thời trang'), 
		('LH00000004', N'Đồ da dụng'),
		('LH00000003', N'Đồ gia đình'),
       ('LH00000002', N'Đồ điện tử');



-- Thêm dữ liệu vào bảng NHACUNGCAP
INSERT INTO NHACUNGCAP (MACONGTY, TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI, FAX, EMAIL) 
VALUES ('NC00000001', N'Công ty ABC', N'GIAO DỊCH 1', N'HẢI CHÂU', '0901234567', '0281234567', 'abc@company.com'),
       ('NC00000002', N'Công ty XYZ', N'GIAO DỊCH 2', N'LIÊN CHIỂU', '0907654321', '0287654321', 'xyz@company.com');

-- Thêm dữ liệu vào bảng KHACHHANG
INSERT INTO KHACHHANG (MAKHACHHANG, TENCONGTY, TENGIAODICH, DIACHI, EMAIL, DIENTHOAI, FAX) 
VALUES ('KH00000001', N'Khách hàng A', N'CÔNG TY A', N'HÒA KHÁNH ', 'a@customer.com', '0912345678', '0281234789'),
		('KH00000003', N'Khách hàng A', N'GIAO DỊCH C', N'HÒA KHÁNH ', 'c@customer.com', '0912345628', '0281234729'),
       ('KH00000002', N'Khách hàng B', N'CÔNG TY B', N'THANH KHÊ', 'b@customer.com', '0918765432', '0289876543');

-- Thêm dữ liệu vào bảng NHANVIEN
INSERT INTO NHANVIEN (MANHANVIEN, TEN, HO, NGAYSINH, NGAYLAMVIEC, DIACHI, DIENTHOAI, LUONGCOBAN, PHUCAP) 
VALUES ('NV00000001', 'Nam', N'Nguyễn', '1990-01-01', '2020-05-15', N'123 Đường E', '0901239876', '6000000', '500000'),
       ('NV00000002', 'Lan', N'Lê', '1985-03-22', '2019-10-10', N'456 Đường F', '0906543210', default, '600000'),
	  ('NV00000003', 'Minh', N'Tran', '1995-04-15', '2023-02-10', N'789 Đường K', '0901234569', '7000000', '500000'),
	  ('NV00000004', 'Vinh', N'Ngô', '1990-01-01', '1980-01-01', N'234 Đường M', '0909871234', '9000000', '700000');


-- Thêm dữ liệu vào bảng MATHANG
INSERT INTO MATHANG (MAHANG, TENHANG, MALOAIHANG, MACONGTY, SOLUONG, DVTINH, GIAHANG) 
VALUES ('MH00000001', N'Tivi Samsung', 'LH00000001', 'NC00000001', 100, N'Cái', 15000000),
       ('MH00000002', N'Máy giặt LG', 'LH00000002', 'NC00000002', 50, N'Cái', 10000000),
	   ('MH00000003', N'Tủ lạnh LG', 'LH00000004', 'NC00000002', 20, N'Cái', 25000),
	    ('MH00000004', N'Tủ lạnh Toshiba', 'LH00000003', 'NC00000001', 0, N'Cái', 12000000);

-- Thêm dữ liệu vào bảng DONDATHANG
INSERT INTO DONDATHANG (SOHOADON, MAKHACHHANG, MANHANVIEN, NGAYDATHANG, NGAYGIAOHANG, NGAYCHUYENHANG, NOIGIAOHANG) 
VALUES ('HD00000001', 'KH00000001', 'NV00000001', '2023-10-10', '2023-10-12', '2023-10-15', N'123 Đường G'),
       ('HD00000002', 'KH00000002', 'NV00000002', '2023-09-20', '2023-09-25', '2023-09-28', N'456 Đường H'),
	   ('HD00000003', 'KH00000001', 'NV00000001', '2009-05-10', '2009-05-15', '2009-05-18', N'123 Đường I');

-- Thêm dữ liệu vào bảng CHITIETDATHANG
INSERT INTO CHITIETDATHANG (SOHOADON, MAHANG, GIABAN, SOLUONG, MUCGIAMGIA) 
VALUES ('HD00000001', 'MH00000001', 15000000, 2, 50000),
       ('HD00000002', 'MH00000002', 10000000, 1, DEFAULT),
	   ('HD00000003', 'MH00000001', 15000000, 1, 50000);
-- Tăng phụ cấp lên 50% lương cho những nhân viên bán được hàng nhiều nhất
WITH NhanVienBanNhieuNhat AS (
   SELECT MANHANVIEN
   FROM CHITIETDATHANG ctdh
  JOIN DONDATHANG dh ON ctdh.SOHOADON = dh.SOHOADON
  GROUP BY MANHANVIEN
  ORDER BY SUM(ctdh.SOLUONG) DESC
   OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY 
-- Giả định chỉ lấy 1 nhân viên bán hàng nhiều nhất
)
UPDATE NHANVIEN
SET PHUCAP = CAST(PHUCAP AS DECIMAL(10, 2)) + (CAST(LUONGCOBAN AS DECIMAL(15, 2)) * 0.5)
WHERE MANHANVIEN IN (SELECT MANHANVIEN FROM NhanVienBanNhieuNhat);
--Giảm 25% lương của những nhân viên trong năm 2023 không lập được bất kỳ đơn đặt hàng nào
WITH NhanVienKhongCoDonDatHang2023 AS (
  SELECT DISTINCT NV.MANHANVIEN
   FROM NHANVIEN nv
   LEFT JOIN DONDATHANG dh ON nv.MANHANVIEN = dh.MANHANVIEN
    WHERE dh.NGAYDATHANG IS NULL OR YEAR(dh.NGAYDATHANG) <> 2023
)
UPDATE NHANVIEN
SET LUONGCOBAN = CAST(LUONGCOBAN AS DECIMAL(15, 2)) * 0.75  -- Giảm 25%
WHERE MANHANVIEN IN (SELECT MANHANVIEN FROM NhanVienKhongCoDonDatHang2023);
DELETE FROM NHANVIEN
WHERE DATEDIFF(YEAR, NGAYLAMVIEC, GETDATE()) > 40;
-- Xóa dữ liệu quá cũ từ bảng DONDATHANG và MATHANG
DELETE FROM DONDATHANG
WHERE NGAYDATHANG < '2010-01-01';
DELETE FROM MATHANG
WHERE SOLUONG = 0 
AND MAHANG NOT IN (
    SELECT MAHANG 
   FROM CHITIETDATHANG
);
SELECT *FROM NHANVIEN
SELECT *FROM DONDATHANG
SELECT *FROM MATHANG
-- Cho biết danh sách các đối tác cung cấp hàng cho công ty
SELECT MACONGTY, TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI, FAX, EMAIL 
FROM NHACUNGCAP;
-- Mã hàng, tên hàng và số lượng của các mặt hàng hiện có trong công ty.
SELECT MAHANG, TENHANG, SOLUONG 
FROM MATHANG
-- Họ tên và địa chỉ và năm bắt đầu làm việc của các nhân viên trong công ty
SELECT HO + ' ' + TEN AS HOTEN, DIACHI, YEAR(NGAYLAMVIEC) AS NAM_BAT_DAU 
FROM NHANVIEN;
-- Địa chỉ và điện thoại của nhà cung cấp có tên giao dịch [VINAMILK]  là gì?
SELECT DIACHI, DIENTHOAI 
FROM NHACUNGCAP 
-- Cho biết mã và tên của các mặt hàng có giá lớn hơn 100000 và số lượng hiện có ít hơn 50
SELECT MAHANG, TENHANG 
FROM MATHANG 
WHERE GIAHANG > 100000 AND SOLUONG < 50;
-- Cho biết mỗi mặt hàng trong công ty do ai cung cấp
SELECT MATHANG.MAHANG, MATHANG.TENHANG, NHACUNGCAP.TENCONGTY
FROM MATHANG , NHACUNGCAP
WHERE MATHANG.MACONGTY = NHACUNGCAP.MACONGTY
-- Công ty [Việt Tiến] đã cung cấp những mặt hàng nào?
SELECT MATHANG.MAHANG, MATHANG.TENHANG 
FROM MATHANG 
JOIN NHACUNGCAP ON MATHANG.MACONGTY = NHACUNGCAP.MACONGTY 
WHERE NHACUNGCAP.TENCONGTY = N'Việt Tiến';
-- Loại hàng thực phẩm do những công ty nào cung cấp và địa chỉ của các công ty đó là gì?
SELECT MATHANG.MAHANG, MATHANG.TENHANG, NHACUNGCAP.TENCONGTY, NHACUNGCAP.DIACHI 
FROM NHACUNGCAP, MATHANG
WHERE MATHANG.MACONGTY = NHACUNGCAP.MACONGTY
-- Những khách hàng nào (tên giao dịch) đã đặt mua mặt hàng Sữa hộp XYZ của công ty?
SELECT KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH
FROM KHACHHANG
JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG
JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
WHERE MATHANG.TENHANG = N'Sữa hộp XYZ';
-- Đơn đặt hàng số 1 do ai đặt và do nhân viên nào lập, thời gian và địa điểm giao hàng là ở đâu?
SELECT KHACHHANG.TENGIAODICH AS KHACH_HANG, 
       NHANVIEN.HO + ' ' + NHANVIEN.TEN AS NHAN_VIEN, 
       DONDATHANG.NGAYDATHANG, DONDATHANG.NOIGIAOHANG 
FROM DONDATHANG 
JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG 
JOIN NHANVIEN ON DONDATHANG.MANHANVIEN = NHANVIEN.MANHANVIEN 
WHERE DONDATHANG.SOHOADON = 'HD00000001';
-- TUAN 10
-- Hãy cho biết số tiền lương mà công ty phải trả cho mỗi nhân viên là bao nhiêu (lương = lương cơ bản + phụ cấp)
SELECT MANHANVIEN, HO, TEN, (LUONGCOBAN + PHUCAP) AS LUONG
FROM NHANVIEN
--Hãy cho biết có những khách hàng nào lại chính là đối tác cung cấp hàng của công ty (tức là có cùng tên giao dịch)
SELECT DISTINCT KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH
FROM KHACHHANG
JOIN NHACUNGCAP ON KHACHHANG.TENGIAODICH = NHACUNGCAP.TENGIAODICH
--Trong công ty có những nhân viên nào có cùng ngày sinh?
SELECT MANHANVIEN, NGAYSINH
FROM NHANVIEN
WHERE NGAYSINH IN (
    SELECT NGAYSINH
    FROM NHANVIEN
    GROUP BY NGAYSINH
    HAVING COUNT(*) > 1
)ORDER BY 
    NGAYSINH, MANHANVIEN;
--Những đơn đặt hàng nào yêu cầu giao hàng ngay tại công ty đặt hàng và những đơn đó là của công ty nào?
SELECT DONDATHANG.SOHOADON, DONDATHANG.NGAYDATHANG, DONDATHANG.NGAYGIAOHANG, DONDATHANG.NOIGIAOHANG, KHACHHANG.DIACHI, KHACHHANG.TENCONGTY
FROM KHACHHANG, DONDATHANG
WHERE
DONDATHANG.NOIGIAOHANG = KHACHHANG.DIACHI AND DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
--Cho biết tên công ty,  tên giao dịch, địa chỉ và điện thoại của các khách hàng và các nhà cung cấp hàng cho công ty.
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI
FROM KHACHHANG
UNION
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI
FROM NHACUNGCAP
--Những mặt hàng nào chưa từng được khách hàng đặt mua?
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE MAHANG NOT IN ( SELECT MAHANG FROM CHITIETDATHANG)
--Những nhân viên nào của công ty chưa từng lập bất kỳ một hoá đơn đặt hàng nào?
SELECT MANHANVIEN, HO + TEN AS HOVATEN
FROM NHANVIEN
WHERE MANHANVIEN NOT IN ( SELECT MANHANVIEN FROM DONDATHANG);
--Những nhân viên nào của công ty có lương cơ bản cao nhất?
SELECT MANHANVIEN, HO, TEN, LUONGCOBAN
FROM NHANVIEN
ORDER BY LUONGCOBAN DESC ;
